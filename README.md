# 练老师工具集 

**练老师工具集**是一个功能丰富的ComfyUI自定义节点集合，旨在通过大语言模型（GLM）赋能图像分析与提示词优化，提升AI创作工作流的效率和质量。

## 🚀 核心功能

- **图像内容反推**：使用GLM视觉大模型分析图像内容，生成详细描述
- **视频/图片提示词优化**：根据专业格式自动扩写和优化提示词
- **API密钥管理**：便捷地保存和管理GLM模型API密钥
- **图像拼接**：将多个图像按指定网格排列拼接成大图
- **提示词构建**：通过结构化参数快速生成专业提示词

## 📋 系统要求

- ComfyUI 最新版本
- Python 3.10+ 
- 网络连接（用于API调用）
- GLM API密钥（需从智谱AI获取）

## 💾 安装方法

1. 将此工具集文件夹放入ComfyUI的`custom_nodes`目录下
2. 安装必要的依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 重启ComfyUI

## 🎯 节点详解

### 1. GLM图像反推节点 (ImageToLLMReverseNode)

**功能**：读取图像并使用GLM视觉大模型分析图像内容，生成详细的文本描述。

**参数说明**：
- **images**: 输入图像
- **reverse_prompt**: 反推要求，指导模型如何分析图像
- **model_type**: 模型类型（当前仅支持"glm"）
- **api_key**: GLM模型API密钥（留空则使用已保存的密钥）
- **model_name**: 模型选择，可选：auto（自动选择）、glm-4v、glm-4.5v
- **temperature**: 温度参数（0.1-1.0），控制输出随机性
- **max_tokens**: 最大生成tokens数（影响输出长度）
- **seed**: 随机种子（0表示随机，>0时可复现结果）

**使用场景**：分析图像内容、生成图像描述、辅助提示词创作

### 2. 视频/图片提示词优化节点 (VideoPromptOptimizerNode)

**功能**：根据专业提示词结构，自动优化和扩写视频或图片相关的提示词。

**参数说明**：
- **input_prompt**: 基础提示词，描述视频或图片内容
- **api_key**: GLM模型API密钥（留空则使用已保存的密钥）
- **model_name**: 模型选择，可选：auto、glm-4v、glm-4.5v、glm-4.5、glm-4.5-flash
- **temperature**: 温度参数（0.1-1.0）
- **max_tokens**: 最大生成tokens数
- **optimization_strength**: 优化强度（0.5-2.0），控制扩写程度
- **optimization_type**: 优化类型，可选：video（视频）、image（图片）

**优化结构**：

- **视频优化**：按照「主体描述 + 场景描述 + 运动描述 + 镜头语言 + 氛围词 + 风格化」六要素结构优化
- **图片优化**：按照「主体描述 + 细节刻画 + 场景与环境 + 构图与视角 + 艺术风格 + 画质与效果」六要素结构优化

**使用场景**：提升提示词质量、标准化创作流程、快速生成专业级提示词

### 3. LLM API密钥管理节点 (LLMAPIKeyManagerNode)

**功能**：方便地保存和清除GLM API密钥配置。

**参数说明**：
- **api_key**: GLM API密钥
- **action**: 操作类型，可选：save（保存）、clear（清除）

### 4. 图像拼接节点 (ImageTilingNode)

**功能**：将多个图像按指定的行列数拼接成一个大图。

**参数说明**：
- **images**: 输入图像批次
- **rows**: 拼接行数（1-100）
- **columns**: 拼接列数（1-100）

**特性**：如输入图像数量不足，将自动用黑色图像填充空缺位置

### 5. 提示词助手节点 (PromptExpansionNode)

**功能**：根据主体描述和各种美学、动态、风格化选项，自动构建完整提示词。

**参数说明**：
- **主体描述**: 详细描述主体特征和环境
- **美学控制选项**（可选）: 光源类型、光线类型、时间段、景别、构图、镜头焦段、机位角度、色调等
- **动态控制选项**（可选）: 运动类型、人物情绪、基本运镜、高级运镜等
- **风格化表现选项**（可选）: 视觉风格、特效镜头等

**使用场景**：快速生成结构化提示词、探索不同风格组合、辅助创作过程

## ⚙️ 配置指南

### API密钥配置

API密钥存储位置：
- 配置目录：`ComfyUI/custom_nodes/lianlaoshi_tools/config/`
- 密钥文件：`config/api_keys.json`
- 环境变量：可设置系统环境变量，优先级高于配置文件

### 注意事项
- 配置文件包含敏感信息，请妥善保管
- 建议使用密钥管理节点进行密钥配置，避免直接编辑配置文件
- 如切换设备或重新安装，请记得备份配置文件

## 💡 使用示例

### 基础图像反推工作流
1. 添加`Load Image`节点加载图像
2. 添加`lian GLM图像反推节点`
3. 连接图像输入，配置反推要求和API密钥
4. 添加`Preview Text`节点查看反推结果
5. 运行工作流

### 视频提示词优化工作流
1. 添加`Text`节点输入基础提示词
2. 添加`lian 视频提示词优化节点`，选择`optimization_type`为`video`
3. 配置优化强度和其他参数
4. 将优化后的提示词连接到视频生成节点
5. 运行工作流

## ❗ 重要提示

1. 使用前需获取GLM模型的API密钥（从智谱AI官方获取）
2. 确保网络连接稳定，API调用需要联网
3. 图像分辨率和大小会影响处理时间和API调用成本
4. 免费版模型可能有调用次数和速率限制
5. 如遇到API调用失败，请检查密钥是否正确、网络是否畅通

## 📝 更新日志

- **最新版本**: 
  - 支持图片提示词优化：VideoPromptOptimizerNode新增图片优化模式，支持千问生图格式
  - 增加随机种子参数：支持控制生成内容的可重复性
  - 优化节点结构：简化用户界面，提升操作体验
  - 文档更新：完善使用说明和参数解释

- **历史更新**: 
  - 视频提示词优化升级：支持通义万相专用格式
  - 功能分离：图像反推与提示词优化功能独立为不同节点
  - 模型优化：专注GLM模型支持，简化代码结构
  - 纯提示词输出：优化结果只包含提示词内容，无额外解释

---

**练老师工具集** © 2025 | 专注于提升AI创作体验的ComfyUI扩展